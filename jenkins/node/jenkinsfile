pipeline {

    // agent node
    agent { 
        node {
            label 'node-2'
            }
    }

    tools {
         nodejs "Node 21.5.0"
    }

    environment {
        CURRENT_VERSION = "1.0.0"
    }
   
    stages {

        stage('Change Directory') {
            steps {
                echo "Changing Directory.."
                sh '''
                    cd jenkins/node
                '''
            }
            
        }

        stage('Build') {
            steps {
                echo "Building app  version ${CURRENT_VERSION}"
                sh '''
                    cd jenkins/node 
                    npm install 
                '''
            }
        }

        stage('Run') {
            when {
                expression {
                    env.BRANCH_NAME == "Master"
                }
            }
            steps {
                echo "Run.."
                sh '''
                    cd jenkins/node 
                    node app.js & sleep 1
                    echo $! > .pidfile
                    kill $(cat .pidfile)
                '''
            }
        }


        stage('Cleanup Workspace') {
            steps {
                deleteDir()
            }
        }

    }


    // post
    post {

        always {
            echo 'Keep learning'
        }

        success {
            echo 'Build successful!'
        }
    
        failure {
            echo 'Build failed. Please check the logs for details.'
        }
    }
}