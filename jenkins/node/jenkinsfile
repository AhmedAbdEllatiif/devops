pipeline {

    //--------------------------------------------------------------------------------------------
    //
    // Define the agent
    //
    //--------------------------------------------------------------------------------------------
    agent { 
        node {
            label 'node-2'
            }
    }


    //--------------------------------------------------------------------------------------------
    //
    // nodejs ==>  custom name for the Node 21.5.0 tool in your Jenkins Pipeline script 
    // Node 21.5.0 ==> is the name of the Node.js installation configured in Jenkins
    //
    //--------------------------------------------------------------------------------------------
    tools {
         nodejs "Node 21.5.0"
    }

    //--------------------------------------------------------------------------------------------
    //
    // Define environment
    //
    //--------------------------------------------------------------------------------------------
    environment {
        CURRENT_VERSION = "1.0.0"
    }
   

    //--------------------------------------------------------------------------------------------
    //
    // Define parameters
    //
    //--------------------------------------------------------------------------------------------
    parameters {
        choice choices: ['dev', 'somke' ,'production'] , name: 'deployEnv', description: 'This is the deployment environment'
    }



    //--------------------------------------------------------------------------------------------
    //
    // Define stages
    //
    //--------------------------------------------------------------------------------------------
    stages {

        stage('Change Directory') {
            steps {
                echo "Changing Directory.."
                sh '''
                    cd jenkins/node
                '''
            }
            
        }

        stage('Build') {
            steps {
                echo "Building app  version ${CURRENT_VERSION}"
                sh '''
                    cd jenkins/node 
                    npm install 
                '''
            }
        }

        stage('Run') {
            when {
                expression {
                    params.BRANCH_NAME == "Master"
                }
            }
            steps {
                echo "Run.."
                sh '''
                    cd jenkins/node 
                    node app.js & sleep 1
                    echo $! > .pidfile
                    kill $(cat .pidfile)
                '''
            }
        }


        stage ("Deploy") {
            script {
                def currentDeployEnv = params.deployEnv

                if(currentDeployEnv == "dev"){
                    echo "Deploying dev environment"
                }
                else if (currentDeployEnv == "somke"){
                    echo "Deploying somke environment"
                }
                else{
                    echo "Deploying production environment"
                }
            }
        }

        stage('Cleanup Workspace') {
            steps {
                deleteDir()
            }
        }

    }

    post {

        always {
            echo 'Keep learning'
        }

        success {
            echo 'Build successful!'
        }
    
        failure {
            echo 'Build failed. Please check the logs for details.'
        }
    }
}